<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="robots" content="noindex">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EquiPath - Lite</title>
  <link rel="icon" type="image/x-icon" href="assets/favicon.png">
  <!-- Bootstrap CSS -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="assets/styles.css">
  <style>
    .alert {
      width: 100%;
      text-align: center;
    }
  </style>
</head>

<body class="flex-column ">
  <div class="custom-max-width">
    <header>
      <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-brand-blue">
        <div class="container-fluid">
          <div id="loading-state">
            <div class="spinner-border spinner-border-sm brand-orange" style="position: fixed;" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
          <span><img src="assets/icon42-white.png"
              style="height: 28px;padding-right: â€’2;padding-right: 4px;padding-bottom: 5px;padding-top: 0px;">
            <span id="brand" class="navbar-text brand-orange h5">EquiPath Lite</span></span>
          <button class="btn btn-sm btn-success fw-bold d-flex" id="signInButton" disabled>Sign In</button>
          <div id="settings" class="d-none">
            <button type="button" class="icon-btn" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="material-icons md-18 mr-1" style="color:white">settings</i>
            </button>
            <div id="dayReport" class="dropdown-menu dropdown-menu-end" style="background-color: bisque;">
              <strong class="dropdown-header">Sessions:</strong>
              <a class="dropdown-item" value="30">30 Day Report</a>
              <a class="dropdown-item" value="60">60 Day Report</a>
              <a class="dropdown-item" value="90">90 Day Report</a>
            </div>
          </div>
        </div>
      </nav>
    </header>
    <main class="flex-shrink-0" id="mainContent">
      <div id="alertTop" class="toast position-fixed top-1 start-50 translate-middle-x" role="alert"
        aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="5000" style="z-index: 100;">
        <div class="toast-header bg-brand-blue">
          <strong class="me-auto">Alert!</strong>
          <button type="button" class="btn-close bg-light" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div id="alertMsg" class="toast-body text-bg-light">
          Loading. . .
        </div>
      </div>
      <div class="accordion p-1" id="uiMain">
        <div class="accordion-item" id="sessionList">
          <span class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
              data-bs-target="#collapseList" aria-expanded="false" aria-controls="collapseList">
              <i class="material-icons p-1">sort</i><span class="h4 m-0">Training Sessions </span>
            </button>
          </span>
          <div id="collapseList" class="accordion-collapse collapse">
            <div class="accordion-body p-1">
              <div id="session-list">
              </div>
            </div>
          </div>
        </div>
        <div class="accordion-item" id="sessionForm">
          <span class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
              data-bs-target="#collapseForm" aria-expanded="false" aria-controls="collapseForm">
              <i class="material-icons p-1">assignment</i><span class="h4">Add Session</span>
            </button>
          </span>
          <div id="collapseForm" class="accordion-collapse collapse">
            <div class="accordion-body p-1">
              <div class="card shadow-sm mb-4">
                <div class="card-body">
                  <h3 class="card-title">Training Session</h3>
                  <div id="session-form"></div>
                  <form id="training-form">
                    <fieldset disabled>
                      <input type="hidden" id="sessionId" value="" />
                      <div class="mb-3">
                        <label for="horseName" class="form-label">Horse Name</label>
                        <input type="text" class="form-control" name="horseName" id="horseName"
                          placeholder="Enter horse's name" required>
                      </div>
                      <div class="mb-3">
                        <label for="trainerName" class="form-label">Trainer Name</label>
                        <input type="text" class="form-control" name="trainerName" id="trainerName"
                          placeholder="Enter trainer's name" required>
                      </div>
                      <div class="mb-3">
                        <label for="sessionDate" class="form-label">Session Date</label>
                        <input type="date" class="form-control" name="sessionDate" id="sessionDate" required>
                      </div>
                      <div class="mb-3">
                        <label for="timeOfDay" class="form-label">Time of Day</label>
                        <select class="form-select" name="timeOfDay" id="timeOfDay" required>
                          <option selected disabled value="">Select Time of Day</option>
                          <option value="Early Morning">Early Morning (Before 8 a.m.)
                          </option>
                          <option value="Morning">Morning (8 a.m. - 11 a.m.)</option>
                          <option value="Late Morning">Late Morning (10 a.m. - 12
                            p.m.)</option>
                          <option value="Noon">Noon (12 p.m.)</option>
                          <option value="Afternoon">Afternoon (12 p.m. - 5 p.m.)
                          </option>
                          <option value="Late Afternoon">Late Afternoon (4 p.m. - 6
                            p.m.)</option>
                          <option value="Evening">Evening (5 p.m. - 8 p.m.)</option>
                          <option value="Night">Night (After 8 p.m.)</option>
                          <option value="Late Night">Late Night (After 10 p.m.)
                          </option>
                        </select>
                      </div>
                      <div class="mb-3">
                        <label for="trainingType" class="form-label">Training
                          Type</label>
                        <select class="form-select" name="trainingType" id="trainingType" required>
                          <option selected disabled value="">Choose an exercise...</option>
                          <option value="Lunging">Lunging</option>
                          <option value="Groundwork Exercises">Groundwork Exercises
                          </option>
                          <option value="Pole Work">Pole Work</option>
                          <option value="Lateral Work">Lateral Work</option>
                          <option value="Transitions Between Gaits">Transitions
                            Between Gaits</option>
                          <option value="Circles and Serpentines">Circles and
                            Serpentines</option>
                          <option value="Backing Up">Backing Up</option>
                          <option value="Desensitization Exercises">Desensitization
                            Exercises</option>
                          <option value="Yielding to Pressure">Yielding to Pressure
                          </option>
                          <option value="Halter and Lead Training">Halter and Lead Training</option>
                          <option value="Trail Work">Trail Work</option>
                          <option value="Liberty Work">Liberty Work</option>
                        </select>
                      </div>
                      <div class="mb-3">
                        <label for="horseMood" class="form-label">Horse Mood</label>
                        <select class="form-select" name="horseMood" id="horseMood" required>
                          <option selected disabled value="">Select mood...</option>
                          <option value="Calm">Calm - Relaxed and steady</option>
                          <option value="Focused">Focused - Attentive and engaged</option>
                          <option value="Playful">Playful - Energetic and curious</option>
                          <option value="Anxious">Anxious - Alert and reactive</option>
                          <option value="Stubborn">Stubborn - Hesitant and resistant</option>
                          <option value="Aggressive">Aggressive - Defensive and wary</option>
                        </select>
                      </div>
                      <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" name="notes" id="notes" rows="3"
                          placeholder="Enter detailed notes for training session"></textarea>
                      </div>
                      <div class="mb-3">
                        <label for="grade" class="form-label">Grade</label>
                        <select class="form-select" name="grade" id="grade">
                          <option value="*" selected disabled>Select grade...</option>
                          <option value="A">A - Excellent progress</option>
                          <option value="B">B - Good progress</option>
                          <option value="C">C - Some progress</option>
                          <option value="D">D - Needs improvement</option>
                          <option value="F">F - No improvement</option>
                        </select>
                      </div>
                      <div class="mb-3">
                        <label for="additionalNotes" class="form-label">Additional
                          Notes</label>
                        <textarea class="form-control" name="additionalNotes" id="additionalNotes" rows="2"
                          placeholder="Enter any extra observations"></textarea>
                      </div>
                      <button id="submit-session" type="submit" class="btn btn-sm btn-primary float-end">Submit</button>
                      <button id="cancel-session" type="button" class="btn btn-sm btn-warning float-end">Cancel</button>
                    </fieldset>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id="welcomeUser" class="card m-1">
        <h5 class="card-header brand-blue">Welcome to EquiPath!</h5>
        <div class="card-body">
          <section class="mb-4">
            <p><strong>EquiPath</strong> is a mobile web app designed to help you track and evaluate your horse's
              training progress,
              with a focus on behavior modification, trust, respect, and partnership.</p>
            <p><strong>Getting Started:</strong> To use EquiPath, please sign in with your Google account for a seamless
              and secure experience. Just hit the <strong>'Sign In'</strong>
              button to get started!</p>
          </section>
        </div>
      </div>
      <div id="stats" class="card m-1 d-none">
        <h5 class="card-header brand-blue">Quick Stats*</h5>
        <div class="card-body">
          <section class="mb-4">
            <ul id="session-stats" class="list-unstyled">
              <li>No Records</li>
            </ul>
          </section>
        </div>
      </div>
      <div class="container text-center">
        <span id="userInfo"></span>
        <hr>
        <p>&copy; 2024 EquiPath by Cowboy Strong.</br>All rights reserved.</p>
      </div>
      <div style="height: 40px;"></div>
    </main>
    <footer class="footer fixed-bottom bg-brand-blue">
      <a type="button" class="btn btn-md brand-orange fw-bold" href="guide.html">Guide</a>
      <button type="button" class="btn btn-md brand-orange fw-bold" id="signOutButton">Sign Out</button>
      <button type="button" class="btn btn-md brand-orange float-end" id="scrollTop">
        <i class="material-icons p-0">vertical_align_top</i>
      </button>
    </footer>
  </div>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js'
    // If you enabled Analytics in your project, add the Firebase SDK for Google Analytics
    import { getAnalytics } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-analytics.js'
    // Add Firebase products that you want to use
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js'
    import { getFirestore, collection, doc, getDoc, getDocs, addDoc, setDoc, where, query, orderBy, limit, Timestamp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js'
    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyD7ZlTdNiy0xaDtypcEvs78kU0mbvk79eE",
      authDomain: "equipathlite.firebaseapp.com",
      projectId: "equipathlite",
      storageBucket: "equipathlite.appspot.com",
      messagingSenderId: "245462160847",
      appId: "1:245462160847:web:a76644967e759abfff6eba",
      measurementId: "G-2GFCW09LX5"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    // const analytics = getAnalytics(app);
    const journals = getFirestore(app);
    const auth = getAuth();
    const provider = new GoogleAuthProvider()

    // data
    var sessionsPath = "Journal/email@domain.com/Sessions"; // points to session documants
    var horsesPath = "Journal/email@domain.com/Horses"; // points to horse documants
    var trainerPath = "Journal/email@domain.com"; // Trainer Document
    const trainer = {
      name: "",
      email: "",
      auth: false,
      active: false,
      date: null
    };
    var sortSessions = 'Date'; // Sort Sessions By...
    const today = new Date();
    var daysAgo = 30;  // ##-Day Activity Report
    function calculatePriorDays(dateString, days) {
      const date = new Date(dateString);
      date.setDate(date.getDate() - days);
      return date.toISOString().split('T')[0]; // Format as YYYY-MM-DD
    }


    provider.setCustomParameters({
      prompt: 'select_account'
    });
    // Lookup Tables
    const horseMood = {
      "Calm": {
        "syntax": "Relaxed and steady",
        "color": "#27ae60",
        "context": "The horse is relaxed, showing steady responsiveness and ease within the environment. Suitable for focus-based exercises and skill-building activities that require patience."
      },
      "Focused": {
        "syntax": "Attentive and engaged",
        "color": "#2980b9",
        "context": "The horse is highly attentive and responsive to cues, actively engaged in the exercises. Ideal for skill refinement or introducing new tasks."
      },
      "Playful": {
        "syntax": "Energetic and curious",
        "color": "#f39c12",
        "context": "The horse is energetic and spirited, displaying curiosity and enthusiasm. Great for exercises that encourage exploration and social interaction but may require guidance to maintain structure."
      },
      "Anxious": {
        "syntax": "Alert and reactive",
        "color": "#e67e22",
        "context": "The horse shows signs of nervousness or tension, possibly distracted by surroundings. Beneficial to work on relaxation techniques or low-pressure exercises to build confidence."
      },
      "Stubborn": {
        "syntax": "Hesitant and resistant",
        "color": "#e74c3c",
        "context": "The horse is resistant or reluctant to follow cues, requiring extra patience and clear guidance. Suitable for reinforcing foundational training with gentle encouragement."
      },
      "Aggressive": {
        "syntax": "Aggressive - Defensive and wary",
        "color": "#c0392b",
        "context": "The horse displays assertive or defensive behavior, potentially due to discomfort or stress. Important to assess for any triggers or health concerns before proceeding with further training."
      }
    };

    const sessionGrade = {
      "A": {
        "syntax": "Excellent progress",
        "color": "#27ae60",
        "context": "The horse demonstrates a strong grasp of skills and exercises, showing consistency, responsiveness, and high engagement throughout the session. There are no major challenges, indicating readiness for new challenges or refinement."
      },
      "B": {
        "syntax": "Good progress",
        "color": "#2ecc71",
        "context": "The horse shows reliable improvement and engages well with cues, though some exercises may still need reinforcement. Progress is evident but can be built upon with continued practice."
      },
      "C": {
        "syntax": "Some progress",
        "color": "#f1c40f",
        "context": "The horse makes partial improvements but shows signs of difficulty with certain aspects of the exercises. The session may require specific focus on a few skills or behavioral adjustments to strengthen response."
      },
      "D": {
        "syntax": "Needs improvement",
        "color": "#e74c3c",
        "context": "The horse faces challenges with attention, responsiveness, or behavior. Adjustments in training approach or environment may help address these issues in future sessions."
      },
      "F": {
        "syntax": "No improvement",
        "color": "#f0003c",
        "context": "The session lacks progress, with the horse showing significant resistance or discomfort. A re-evaluation of training methods or an assessment of external factors may be necessary."
      },
      "*": {
        "syntax": "No Grade",
        "color": "#f0003c",
        "context": "The session was ungraded, potentially due to an incomplete session, unforeseen interruption, or a non-evaluative day for rest or recovery."
      }
    };

    // messages
    const _gettingRecords = `<div class="alert alert-light fw-bold" role="alert">Fetching Session Records</div>`;
    const _noRecords = `<div class="alert fw-bold" role="alert">No Session Records Found</div>`;
    const _loggedOut = `<div class="alert fw-bold" role="alert">You have been signed out of EquiPath</div>`;
    const _notLoggedIn = `<div class="alert fw-bold" role="alert">You must be Signed In to add new Training Sessions</div>`;

    const topToast = bootstrap.Toast.getOrCreateInstance('#alertTop'); // Returns a Bootstrap toast instance

    function displayAlert(_msg = "Loading...") {
      var alert = document.getElementById('alertMsg');
      alert.innerHTML = _msg;
      topToast.show();
    }

    // UI/UX
    const fieldSet = document.querySelector('#training-form fieldset');
    //console.log(document.querySelector('#training-form fieldset'));
    // Session Form / List
    const mainContent = document.getElementById("topMain");
    const collapseForm = bootstrap.Collapse.getOrCreateInstance(document.getElementById('collapseForm'));
    const sessionFormView = document.getElementById("sessionForm");
    const sessionForm = document.getElementById("training-form");
    const collapseList = bootstrap.Collapse.getOrCreateInstance(document.getElementById('collapseList'));
    const sessionListView = document.getElementById("sessionList");
    const sessionList = document.getElementById("session-list");
    const sessionStats = document.getElementById("session-stats");
    // Messages
    const welcomeUser = document.getElementById("welcomeUser");
    const formAlert = document.getElementById('session-form');
    const userInfo = document.getElementById('userInfo');
    // clear form on tab close
    sessionFormView.addEventListener("hide.bs.collapse", function () {
      sessionForm.reset();
      sessionForm.sessionId.value = "";
      sessionListView.scrollIntoView();
    });
    const tabs = document.getElementsByClassName('accordion-button');
    function diableTabs(state = true) {
      Array.prototype.forEach.call(tabs, function (el) {
        el.disabled = state;
        // console.log(el.disabled);
      });

    }
    // Close all tabs and Scroll to top-of-page
    function topFunction() {
      collapseList.hide();
      collapseForm.hide();
      document.body.scrollTop = 0; // For Safari
      document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
    }
    const scrollToTop = document.getElementById("scrollTop");
    scrollToTop.addEventListener('click', topFunction);
    function scrollToElement(elementId) {
      const element = document.getElementById(elementId);
      //  console.log(elementId);
      if (element) {
        element.scrollIntoView({
          behavior: 'smooth' // Optional for smooth scrolling
        });

      }
    }
    // Settings Events
    // Get the dayReport div
      const dayReportDiv = document.getElementById('dayReport');

      // Get all dropdown-item elements within the dayReport div
      const dropdownItems = dayReportDiv.querySelectorAll('.dropdown-item');

      // Add a click event listener to each dropdown-item
      dropdownItems.forEach(item => {
        item.addEventListener('click', (event) => {
          // Handle the click event here
          event.preventDefault(); // Prevent default link behavior
          daysAgo = item.getAttribute('value');
          showSessions(sortSessions);
        });
      });
    
    // Sign-In / Sign-Out

    // Auth/SignIn
    const userSignIn = async () => {
      document.getElementById('loading-state').style.display = 'flex'
      signInWithPopup(auth, provider)
        .then((result) => {
          const user = trainer.name = result.user;
          trainer.email = result.email;
          trainer.active = true;
          fieldSet.disabled = false;
        }).catch((error) => {
          const errorCode = error.code;
          const errorMessage = error.message
        })
    }

    const userSignOut = async () => {
      signOut(auth).then(() => {
        // clear data
        trainer.active = false;
        displayAlert(_loggedOut);
        fieldSet.disabled = true;
        sessionList.innerHTML = _noRecords;
        formAlert.innerHTML = _notLoggedIn;
        document.getElementById('stats').classList.add('d-none');
      }).catch((error) => {
        const errorCode = error.code;
        const errorMessage = error.message
      });
    }
    const signInButton = document.getElementById("signInButton");
    const signOutButton = document.getElementById("signOutButton");
    signInButton.addEventListener('click', userSignIn);
    signOutButton.addEventListener('click', userSignOut);

    onAuthStateChanged(auth, (user) => {
      // Check Sign-In State
      if (user) {
        signInButton.style.visibility = "hidden";
        signOutButton.style.visibility = "visible";
        document.getElementById('settings').classList.remove('d-none');
        // addSessionButton.style.visibility = "visiable";
        // enable form submit
        //document.getElementById('submit-session').disable = false;
        // diableTabs(false);
        // set user 
        trainer.name = user.displayName;
        trainer.email = user.email;
        trainer.active = trainer.auth = true;
        // set Journal path
        sessionsPath = 'Journal/' + user.email + '/Sessions';
        sessionList.innerHTML = _gettingRecords;
        formAlert.innerHTML = "";
        welcomeUser.style.display = "none";
        fieldSet.disabled = false;
        userInfo.innerText = "Signed In: " + trainer.name;
        showSessions(sortSessions);  // inital view 
      } else {
        trainer.name = "Guest";
        trainer.email = "";
        trainer.active = trainer.auth = false;
        sessionsPath = "";
        userInfo.innerText = "";
        welcomeUser.style.display = "block";
        signInButton.style.visibility = "visible";
        document.getElementById('settings').classList.add('d-none');
        signOutButton.style.visibility = "hidden";
        //diableTabs();
        displayAlert(_notLoggedIn);
        // document.getElementById('submit-session').disable = false;

        signInButton.disabled = false;
        collapseForm.hide();
        collapseList.hide();
      }
      document.getElementById('loading-state').style.display = 'none'
    });

    // render session list
    function showSessions(sort = "Date") {
      document.getElementById('loading-state').style.display = 'flex';
      //  NEEDS REVIEW
      if (sort == 'Date') {
        fetchSessions().then((sessionList) => {
          const dataArray = groupByDate(sessionList);
          renderSessions(dataArray);
        });
      }
      else {
        fetchSessions().then((sessionList) => {
          const dataArray = groupByHorse(sessionList);
          renderSessions(dataArray);
        });
      }
      sessionListView.scrollIntoView();
      collapseList.show();
      document.getElementById('loading-state').style.display = 'none'
    }

    // FireStore
    var lastDoc = null;
    // Fetch sessions from Firestore and render
    async function fetchSessions() {
      let q;
      let startDate = calculatePriorDays(today, daysAgo);
      // console.log(startDate);
      const journalRef = collection(journals, sessionsPath);
      if (sortSessions === "Date") {
        q = query(journalRef, orderBy('Date', 'desc'), where('Date', '>=', startDate));
      }
      else if (sortSessions === "HorseName") {
        q = query(journalRef, orderBy('HorseName', 'asc'), orderBy('Date', 'desc'), where('Date', '>=', startDate));
      }
      else {
        q = query(journalRef); // un-sorted
      }
      const querySnapshot = await getDocs(q);
      // 
      lastDoc = querySnapshot.docs[querySnapshot.docs.length - 1];
      // console.log(lastDoc);
      const sessions = querySnapshot.docs.map(doc => { var rec = doc.data(); rec.id = doc.id; return rec });
      return sessions;
    }

    // Fetch single session 
    async function getDocumentById(documentId) {

      try {
        const docRef = doc(journals, sessionsPath, documentId);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          // Load form for updating
          populateSessionForm(docSnap.id, docSnap.data());
          // 
        } else {
          displayAlert('No such document!');
        }
      } catch (error) {
        // 
        displayAlert('Error getting document');
        console.error('Error getting document:', error);
      }
      finally {

      }

    }

    let horseList = null;
    function listHorses(column) {

    }
    function groupByDate(sessionQuery) {
      horseList = {};  // empty list
      const groupedData = {};
      sessionQuery.forEach((session) => {
        // 

        const date = new Date(session.Date);
        const monthYear = date.toLocaleString('default', { month: 'short', year: 'numeric' });
        //
        if (!groupedData[monthYear]) {
          groupedData[monthYear] = [];
        }
        groupedData[monthYear].push(session);
        // unique horse names
        if (session.HorseName !== '') {
          if (!horseList[session.HorseName]) {
            horseList[session.HorseName] = { Name: session.HorseName, Count: 0, Session: session.SessionType, Grade: session.SessionGrade, LastSession: session.Date };
          }
          horseList[session.HorseName].Count++;
        }
      });

      return groupedData;
    }

    function groupByHorse(sessionQuery) {
      horseList = {};  // empty list
      const groupedData = {};
      sessionQuery.forEach((session) => {
        // 
        const horse = session.HorseName;
        //
        if (!groupedData[horse]) {
          groupedData[horse] = [];
        }
        groupedData[horse].push(session);

        if (session.HorseName !== '') {
          if (!horseList[session.HorseName]) {
            horseList[session.HorseName] = { Name: session.HorseName, Count: 0, Session: session.SessionType, Grade: session.SessionGrade, LastSession: session.Date };
          }
          horseList[session.HorseName].Count++;
        }
      });
      return groupedData;
    }

    // Populate UI - Session List
    function renderSessions(data) {
      document.getElementById('session-list').innerHTML = ""; // Clear
      if (Object.keys(data).length === 0) {
        sessionList.innerHTML = _noRecords;
        return;
      }
      let i = 0;
      let html = `
          <div class="container session-group p-0" >
            <div class="d-inline fw-bold">Sort By: &nbsp;
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="sortBy" id="sortByDate" value="Date" ${sortSessions === 'Date' ? 'checked' : ''}>
                <label class="form-check-label" for="sortByDate">Date</label>
              </div
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="sortBy" id="sortByHorse" value="HorseName" ${sortSessions === 'HorseName' ? 'checked' : ''}>
                <label class="form-check-label" for="sortByHorse">Horse</label>
              </div>   
              <div class="d-inline float-end">${daysAgo}-Day Report</div>           
            </div>
            <ul class="list-unstyled m-1">`;
      Object.keys(data).forEach((key, index) => {
        const sessionList = data[key];

        sessionList.forEach((session) => {
          // console.log(i, 'br'); } i++;
          html += `
          <li class="mb-3 p-1">
            ${i++ !== 0 ? '<hr>' : ''}
            <div class="d-flex justify-content-between align-items-center">
              <h4 class="mb-1">${session.HorseName}</h4>
              <div id="${session.id}">
                <button class="icon-btn" id="edit-session" aria-label="Edit">
                    <i class="material-icons md-18 mr-1">edit</i>
                </button>
                <button class="icon-btn" id="share-session" aria-label="Share">
                    <i class="material-icons md-18 mr-1">share</i>
                </button>
              </div>  
           </div>
        <strong class="card-subtitle">${session.SessionType}</strong>
        <hr>
        <strong>Date:</strong> ${session.Date} - ${session.TimeOfDay} <br>
        <strong>Mood:</strong>
        <span style="color:${horseMood[session.HorseMood].color}; font-weight: bold;">
                        ${session.HorseMood}</span> - ${horseMood[session.HorseMood].syntax} </br>
                        <strong>Notes:</strong> ${session.SessionNotes || 'No additional notes.'}<br>
        <strong>Grade:</strong>
                    <span style="color:${sessionGrade[session.SessionGrade].color}; font-weight: bold;">
                        ${session.SessionGrade}</span> - ${sessionGrade[session.SessionGrade].syntax}
                    </br> 
        <strong>Additional Notes:</strong> ${session.AdditionalNotes || 'No additional notes.'} </br>
        <strong>Trainer:</strong> ${session.TrainerName} 
        <!-- Details -->            
      </li>`;
        });
      });
      html += `</ul></div >`; // Close the main accordion
      document.getElementById('session-list').innerHTML = html;
      // Assign events to edit buttons
      const editEvents = document.querySelectorAll('#edit-session');
      editEvents.forEach(element => {
        element.addEventListener('click', (e) => {
          getDocumentById(element.parentNode.id);
          // collapseForm.show();
        });
      });
      // Assign events to share buttons
      const shareEvents = document.querySelectorAll('#share-session');
      shareEvents.forEach(element => {
        element.addEventListener('click', (e) => {
          // Handle the click event here
          // const sessionId = getDocumentById(element.parentNode.id);
          const detailsURL = "details.html?path=" + sessionsPath + "&id=" + element.parentNode.id;
          window.open(detailsURL, "_blank");
        });
      });
      // Assign Sort By Radios
      const sortByBtn = document.querySelectorAll('input[name="sortBy"]');
      sortByBtn.forEach(button => {
        button.addEventListener('change', () => {
          if (button.checked) {
            sortSessions = button.value; // Access the value of the selected radio button
            // console.log("Selected value:", sortSessions);
            // Do something with the selected value, like update a form field
            showSessions(sortSessions);

          }
        });
      });
      renderStats();
      document.getElementById('loading-state').style.display = 'none'
    }

    // Pupulate UI - Session Stats
    function renderStats() {
      sessionStats.innerHTML = ""; // Clear
      if (Object.keys(horseList).length === 0) {
        return;
      }
      //console.log(horseList);
      let html = '';
      Object.keys(horseList).forEach((key, index) => {
        const horseData = horseList[key];
        html += `<li id="${key}" class="mb-3 p-0"><strong>
          ${horseData.Name}</strong> (${horseData.Count}) - <strong>${horseData.LastSession}</strong>
          </br> 
            ${horseData.Session} <span style="color:${sessionGrade[horseData.Grade].color}; font-weight: bold;">
            (${sessionGrade[horseData.Grade].syntax})</span></li>`;
      });
      html += `</ul><div class="d-inline float-start">*Last ${daysAgo} Days</div>`;
      sessionStats.innerHTML = html;
      document.getElementById('stats').classList.remove('d-none');
      // sessionStats.classList.remove('d-none');
    };

    // create a timeStamp for faster queries -- 2024-11
    function dateStringToTimestamp(dateString) {
      const date = new Date(dateString + 'T12:00:00.000z');
      // console.log(date);
      const timestamp = Timestamp.fromDate(date);
      return timestamp;
    }
    // Cancel Edit Session
    document.getElementById('cancel-session').addEventListener('click', async function (e) {
      e.preventDefault();
      collapseForm.hide();
      sessionForm.reset();
    });
    // Add/Update Session
    document.getElementById('training-form').addEventListener('submit', async function (e) {
      e.preventDefault();
      let sessionData = {
        HorseName: sessionForm.horseName.value,
        TrainerName: sessionForm.trainerName.value,
        Date: sessionForm.sessionDate.value,
        TimeOfDay: sessionForm.timeOfDay.value,
        HorseMood: sessionForm.horseMood.value,
        SessionType: sessionForm.trainingType.value,
        SessionNotes: sessionForm.notes.value || '',
        SessionGrade: sessionForm.grade.value || '',
        AdditionalNotes: sessionForm.additionalNotes.value || '',
        _timeStamp_: dateStringToTimestamp(sessionForm.sessionDate.value) // Added 2014-11-16
      }
      // console.log(sessionForm.sessionId.value);
      if (sessionForm.sessionId.value === "") { // Add
        if (!trainer.auth) {
          sessionForm.reset();
          collapseForm.hide();
          sessionListView.scrollIntoView();
          displayAlert(_notLoggedIn);
          collapseList.show();
          return;
        }
        // Add Session
        try {
          const newDocRef = await addDoc(collection(journals, sessionsPath), sessionData);
        } catch (error) {
          console.error("Error adding document:", error);
        }
      }
      else {
        // Update Session
        try {
          const docRef = doc(journals, sessionsPath, sessionForm.sessionId.value);
          await setDoc(docRef, sessionData);
        } catch (error) {
          console.error("Error updating document:", error);
        }
      }

      // clear form and re-render
      collapseForm.hide();
      showSessions(sortSessions);
      scrollToElement(sessionForm.sessionId.value);
      sessionForm.reset();
    });

    // Populate Session Form
    function populateSessionForm(id, session) {
      collapseForm.show();
      sessionForm.reset();
      sessionForm.sessionId.value = id;
      sessionForm.horseName.value = session.HorseName;
      sessionForm.trainerName.value = session.TrainerName;
      sessionForm.sessionDate.value = session.Date;
      sessionForm.timeOfDay.value = session.TimeOfDay;
      sessionForm.horseMood.value = session.HorseMood;
      sessionForm.trainingType.value = session.SessionType;
      sessionForm.notes.value = session.SessionNotes;
      sessionForm.grade.value = session.SessionGrade;
      sessionForm.additionalNotes.value = session.AdditionalNotes;
      collapseList.hide();
      topFunction(); // scroll to top of page

    };
    // Set Trainer 
    document.getElementById('trainerName').addEventListener('focus', function () {
        if (this.value === '') {
          this.value = trainer.name;
        }
      });
    
      
    // Initialize 
    sessionList.innerHTML = _noRecords;
    formAlert.innerHTML = _notLoggedIn;



  </script>
</body>

</html>